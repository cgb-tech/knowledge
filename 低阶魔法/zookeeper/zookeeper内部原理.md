# Zookeeper内部原理

### 选举机制

- 半数机制：集群中半数以上的机器存活时，集群可用。所以zookeeper适合安装奇数台服务器
- 选举策略：
  - 上来的服务器先投自己一票，如果不满足半数以上则投较大的那个节点
  - 一单leader选择出来，那么后面节点将不参与选举机制

### 节点类型

- 持久（Persistent）：客服端和服务器断开连接后，创建的节点不删除
  - 持久化目录节点：客户端与Zookeeper断开连接后，该节点依旧存在
  - 持久化顺序编号目录节点：客户端与zookeeper断开连接后，该节点依旧存在，但zookeeper给该节点名称进行顺序编号（创建zNode时，名称会附加一个值，顺序号是一个单调递增的计数器，由父节点维护）
- 短暂（Ephemeral）：客户端和服务器端断开连接后，创建的节点自己删除
  - 临时目录节点：服务器断开，该节点删除
  - 临时顺序编号目录节点：客户端与zookeeper断开连接后，该节点被删除，只是zookeeper给该节点名称进行顺序编号

### 监听器原理*

- 首先有一个main线程
- 在main线程中创建zookeeper客户端，这时就会创建两个线程，一个负责网络间接通信（connect），一个负责监听（listener)
- 通过connect线程将注册的监听事件发送给zookeeper
- 在zookeeper的注册器列表中将注册的监听事件添加到列表中
- zookeeper监听到有数据或路径滨化，就会讲这个消息发送给listener线程
- listener线程内部调用了process（）方法
- 监听的是`节点数据`和`子节点增减`的变化
- ![1580263821439](C:\Users\888\AppData\Roaming\Typora\typora-user-images\1580263821439.png)

### 写数据流程



